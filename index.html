<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
  <title>場地借用登記系統</title>
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- 引入 RemixIcon 圖示庫 (讓介面更現代) -->
  <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">
  <style>
    /* 自定義滾動條樣式 */
    ::-webkit-scrollbar { width: 6px; height: 6px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
    ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
    /* 手機版卡片動畫 */
    .mobile-card { transition: transform 0.2s; }
    .mobile-card:active { transform: scale(0.98); }
  </style>
  <script>
    // 您的 GAS 網址
    const GAS_ENDPOINT = ""; 
  </script>
</head>
<body class="bg-gray-50 text-slate-800 min-h-screen font-sans selection:bg-indigo-100 selection:text-indigo-700">
  
  <div class="max-w-7xl mx-auto p-4 lg:p-6 space-y-6">

    <!-- Header -->
    <header class="bg-white rounded-2xl border border-gray-200 shadow-sm p-5 md:p-6 flex flex-col md:flex-row items-start md:items-center justify-between gap-4 relative overflow-hidden">
      <div class="absolute top-0 left-0 w-1 h-full bg-gradient-to-b from-indigo-500 to-purple-600"></div>
      <div>
        <h1 class="text-2xl md:text-3xl font-bold tracking-tight text-slate-800 flex items-center gap-2">
          <i class="ri-calendar-check-line text-indigo-600"></i> 場地借用登記
          <span class="text-xs bg-indigo-100 text-indigo-700 px-2 py-1 rounded-md font-medium tracking-wide align-middle">內部版</span>
        </h1>
        <p class="text-slate-500 text-sm mt-1">支援教室與各類訓練場地之預約管理</p>
      </div>
      
      <div class="flex flex-wrap gap-2 w-full md:w-auto">
        <button id="exportCsvBtn" class="flex-1 md:flex-none flex items-center justify-center gap-1 px-3 py-2 rounded-lg border border-gray-200 bg-white text-sm font-medium hover:bg-gray-50 hover:text-indigo-600 transition text-slate-600 shadow-sm">
          <i class="ri-file-excel-2-line"></i> 匯出 CSV
        </button>
        <div class="relative group">
          <button class="flex-1 md:flex-none flex items-center justify-center gap-1 px-3 py-2 rounded-lg border border-gray-200 bg-white text-sm font-medium hover:bg-gray-50 hover:text-indigo-600 transition text-slate-600 shadow-sm">
             <i class="ri-database-2-line"></i> 資料維護
          </button>
          <!-- 下拉選單 -->
          <div class="absolute right-0 mt-1 w-48 bg-white rounded-xl shadow-xl border border-gray-100 hidden group-hover:block z-20 p-1 animate-fade-in">
            <button id="exportJsonBtn" class="w-full text-left px-3 py-2 rounded-lg hover:bg-indigo-50 text-sm text-slate-600 hover:text-indigo-600 flex items-center gap-2">
              <i class="ri-download-cloud-line"></i> 備份 JSON
            </button>
            <label class="w-full text-left px-3 py-2 rounded-lg hover:bg-indigo-50 text-sm text-slate-600 hover:text-indigo-600 cursor-pointer flex items-center gap-2">
              <i class="ri-upload-cloud-line"></i> 復原備份
              <input id="importJsonInput" type="file" accept="application/json" class="hidden"/>
            </label>
          </div>
        </div>
      </div>
    </header>

    <main class="grid lg:grid-cols-12 gap-6 items-start">
      
      <!-- 左側：表單區 (佔 4/12) -->
      <section class="lg:col-span-4 space-y-6">
        <div class="bg-white rounded-2xl shadow-sm border border-gray-200 overflow-hidden">
          <div class="p-4 border-b border-gray-100 bg-gray-50/50 flex justify-between items-center">
            <h2 class="font-semibold text-slate-700 flex items-center gap-2">
              <i class="ri-edit-circle-line text-indigo-500"></i> <span id="formTitle">新增預約</span>
            </h2>
            <button id="cancelEditBtn" class="hidden text-xs text-rose-500 hover:bg-rose-50 px-2 py-1 rounded transition">
              <i class="ri-close-circle-line"></i> 取消編輯
            </button>
          </div>
          
          <form id="bookingForm" class="p-5 space-y-5">
            <input type="hidden" id="editId"> 

            <!-- 區塊 1: 誰要借 -->
            <div class="space-y-3">
              <label class="text-xs font-bold text-slate-400 uppercase tracking-wider">借用單位資訊</label>
              <div class="grid grid-cols-1 gap-3">
                <div class="relative">
                  <i class="ri-community-line absolute left-3 top-3 text-gray-400"></i>
                  <input id="unit" type="text" placeholder="借用單位名稱 *" class="pl-9 w-full rounded-lg border-gray-200 bg-gray-50 focus:bg-white focus:border-indigo-500 focus:ring-2 focus:ring-indigo-100 text-sm py-2.5 transition" required>
                </div>
                <div class="grid grid-cols-2 gap-3">
                  <div class="relative">
                    <i class="ri-user-line absolute left-3 top-3 text-gray-400"></i>
                    <input id="contact" type="text" placeholder="聯絡人 *" class="pl-9 w-full rounded-lg border-gray-200 bg-gray-50 focus:bg-white focus:border-indigo-500 focus:ring-2 focus:ring-indigo-100 text-sm py-2.5 transition" required>
                  </div>
                  <div class="relative">
                    <i class="ri-phone-line absolute left-3 top-3 text-gray-400"></i>
                    <input id="phone" type="tel" placeholder="電話 *" class="pl-9 w-full rounded-lg border-gray-200 bg-gray-50 focus:bg-white focus:border-indigo-500 focus:ring-2 focus:ring-indigo-100 text-sm py-2.5 transition" required>
                  </div>
                </div>
              </div>
            </div>

            <hr class="border-dashed border-gray-200">

            <!-- 區塊 2: 借什麼 -->
            <div class="space-y-3">
              <label class="text-xs font-bold text-slate-400 uppercase tracking-wider">場地與時間</label>
              <select id="facility" class="w-full rounded-lg border-gray-200 bg-white focus:border-indigo-500 focus:ring-2 focus:ring-indigo-100 text-sm py-2.5 transition" required>
                <option value="" disabled selected>選擇場地...</option>
                <optgroup label="教室">
                  <option>教室701</option>
                  <option>教室702</option>
                  <option>教室703</option>
                </optgroup>
                <optgroup label="訓練場">
                  <option>空呼氣訓練場</option>
                  <option>燃燒櫃</option>
                  <option>燃燒室</option>
                  <option>大直訓練場</option>
                </optgroup>
              </select>

              <div class="relative">
                 <i class="ri-calendar-line absolute left-3 top-3 text-gray-400"></i>
                 <input id="date" type="date" class="pl-9 w-full rounded-lg border-gray-200 focus:border-indigo-500 focus:ring-2 focus:ring-indigo-100 text-sm py-2.5 text-slate-600" required>
              </div>

              <div class="grid grid-cols-2 gap-3">
                <div>
                  <label class="text-xs text-slate-500 mb-1 block">開始時間</label>
                  <input id="startTime" type="time" class="w-full rounded-lg border-gray-200 focus:border-indigo-500 focus:ring-2 focus:ring-indigo-100 text-sm py-2" required>
                </div>
                <div>
                  <label class="text-xs text-slate-500 mb-1 block">結束時間</label>
                  <input id="endTime" type="time" class="w-full rounded-lg border-gray-200 focus:border-indigo-500 focus:ring-2 focus:ring-indigo-100 text-sm py-2" required>
                </div>
              </div>
              <div id="timeError" class="hidden text-xs text-rose-500 font-medium flex items-center gap-1">
                <i class="ri-error-warning-fill"></i> 結束時間必須晚於開始時間
              </div>

              <textarea id="purpose" rows="2" placeholder="借用用途簡述 (選填)" class="w-full rounded-lg border-gray-200 bg-gray-50 focus:bg-white focus:border-indigo-500 focus:ring-2 focus:ring-indigo-100 text-sm py-2 px-3 resize-none"></textarea>
            </div>

            <!-- 進階選項摺疊 -->
            <details class="group rounded-lg border border-gray-200 bg-white open:bg-gray-50 transition-all duration-200">
              <summary class="flex cursor-pointer items-center justify-between p-3 text-sm font-medium text-slate-600 hover:text-indigo-600">
                <span><i class="ri-calendar-todo-line mr-1"></i> 批次多日登記</span>
                <i class="ri-arrow-down-s-line transition group-open:rotate-180"></i>
              </summary>
              <div class="p-3 pt-0 space-y-3 border-t border-gray-100 mt-2">
                 <div class="grid grid-cols-2 gap-3">
                    <div>
                       <label class="text-xs text-slate-500">起始</label>
                       <input id="dateStart" type="date" class="w-full rounded-md border-gray-200 text-xs py-1.5">
                    </div>
                    <div>
                       <label class="text-xs text-slate-500">結束</label>
                       <input id="dateEnd" type="date" class="w-full rounded-md border-gray-200 text-xs py-1.5">
                    </div>
                 </div>
                 <label class="flex items-center gap-2 text-xs text-slate-600 cursor-pointer">
                    <input id="excludeWeekend" type="checkbox" class="rounded text-indigo-600 focus:ring-indigo-500 border-gray-300">
                    排除週六日
                 </label>
                 <div>
                    <label class="text-xs text-slate-500 block mb-1">排除日期 (YYYY-MM-DD, 逗號隔開)</label>
                    <input id="excludeDates" type="text" class="w-full rounded-md border-gray-200 text-xs py-1.5" placeholder="例: 2025-01-01">
                 </div>
                 <div class="text-[10px] text-orange-500 bg-orange-50 p-2 rounded">
                   <i class="ri-alert-line"></i> 編輯模式下批次功能將被停用
                 </div>
              </div>
            </details>

            <button type="submit" id="submitBtn" class="w-full rounded-xl bg-indigo-600 text-white py-3 text-sm font-semibold shadow-lg shadow-indigo-200 hover:bg-indigo-700 hover:shadow-indigo-300 active:scale-[0.98] transition-all flex items-center justify-center gap-2">
              <i class="ri-check-double-line"></i> <span>送出登記</span>
            </button>
          </form>
        </div>
      </section>

      <!-- 右側：清單區 (佔 8/12) -->
      <section class="lg:col-span-8 flex flex-col gap-4 h-full min-h-[500px]">
        <!-- 篩選工具列 -->
        <div class="bg-white p-3 rounded-xl shadow-sm border border-gray-200 flex flex-col sm:flex-row gap-3 items-center justify-between sticky top-2 z-10">
          <div class="flex gap-2 w-full sm:w-auto overflow-x-auto pb-1 sm:pb-0 no-scrollbar">
             <div class="relative min-w-[140px]">
               <i class="ri-calendar-event-line absolute left-2.5 top-2 text-gray-400"></i>
               <input id="filterDate" type="date" class="pl-8 w-full rounded-lg border-gray-200 text-sm py-1.5 focus:ring-indigo-500 focus:border-indigo-500">
             </div>
             <select id="filterFacility" class="rounded-lg border-gray-200 text-sm py-1.5 pl-2 pr-8 focus:ring-indigo-500 focus:border-indigo-500 min-w-[120px]">
                <option value="">全部場地</option>
                <option>教室701</option>
                <option>教室702</option>
                <option>教室703</option>
                <option>空呼氣訓練場</option>
                <option>燃燒櫃</option>
                <option>燃燒室</option>
                <option>大直訓練場</option>
             </select>
          </div>
          <div class="flex gap-2 w-full sm:w-auto">
             <div class="relative w-full">
                <i class="ri-search-line absolute left-3 top-2 text-gray-400"></i>
                <input id="searchInput" type="text" placeholder="搜尋單位/聯絡人..." class="pl-9 w-full rounded-lg border-gray-200 bg-gray-50 text-sm py-1.5 focus:bg-white transition">
             </div>
             <button id="clearFilters" class="whitespace-nowrap px-3 py-1.5 rounded-lg bg-gray-100 hover:bg-gray-200 text-slate-600 text-sm transition" title="清除篩選">
               <i class="ri-filter-off-line"></i>
             </button>
          </div>
        </div>

        <!-- 資料列表 (Desktop: Table, Mobile: Cards) -->
        <div class="bg-white rounded-2xl shadow-sm border border-gray-200 flex-grow overflow-hidden flex flex-col">
          <div class="overflow-auto flex-grow">
            <!-- 電腦版表格 -->
            <table class="w-full text-sm text-left hidden md:table">
              <thead class="bg-gray-50 text-slate-500 font-medium sticky top-0 shadow-sm">
                <tr>
                  <th class="p-4 whitespace-nowrap w-28">日期</th>
                  <th class="p-4 whitespace-nowrap w-32">時間</th>
                  <th class="p-4 whitespace-nowrap w-32">場地</th>
                  <th class="p-4">借用資訊</th>
                  <th class="p-4 text-right w-24">操作</th>
                </tr>
              </thead>
              <tbody id="bookingTbody" class="divide-y divide-gray-100"></tbody>
            </table>

            <!-- 手機版卡片列表 -->
            <div id="mobileCardList" class="md:hidden p-4 space-y-3 bg-gray-50/50 min-h-full"></div>
            
            <!-- 空狀態 -->
            <div id="emptyState" class="hidden flex-col items-center justify-center py-16 text-center">
              <div class="w-16 h-16 bg-indigo-50 rounded-full flex items-center justify-center mb-3">
                 <i class="ri-inbox-line text-3xl text-indigo-300"></i>
              </div>
              <p class="text-slate-500 font-medium">目前沒有符合的預約</p>
              <p class="text-slate-400 text-xs mt-1">請嘗試調整篩選條件或新增一筆</p>
            </div>
          </div>
          
          <div class="p-3 border-t border-gray-100 bg-gray-50 text-xs text-center text-slate-400">
            顯示 <span id="countDisplay">0</span> 筆資料
          </div>
        </div>
      </section>

    </main>
  </div>

  <!-- 懸浮 Toast 通知 -->
  <div id="toast" class="fixed bottom-6 left-1/2 -translate-x-1/2 px-5 py-3 rounded-full shadow-xl text-white font-medium text-sm transition-all transform duration-300 z-50 opacity-0 translate-y-10 flex items-center gap-2 pointer-events-none">
  </div>

  <script>
    const $ = (s) => document.querySelector(s);
    const STORAGE_KEY = 'facility_bookings_v2';
    
    // Utilities
    const todayISO = () => new Date().toISOString().slice(0, 10);
    const timeToMin = (t) => { const [h, m] = t.split(':').map(Number); return h * 60 + m; };
    const overlap = (a, b, c, d) => Math.max(a, c) < Math.min(b, d);
    
    // Load/Save
    function load() { try { return JSON.parse(localStorage.getItem(STORAGE_KEY)) || [] } catch { return [] } }
    function save(d) { localStorage.setItem(STORAGE_KEY, JSON.stringify(d)); }

    // Initialize
    $('#date').value = todayISO();
    const form = $('#bookingForm');
    const editIdInput = $('#editId');
    const submitBtn = $('#submitBtn');
    const cancelEditBtn = $('#cancelEditBtn');
    const bookingTbody = $('#bookingTbody');
    const mobileCardList = $('#mobileCardList');
    const emptyState = $('#emptyState');
    const countDisplay = $('#countDisplay');
    
    // 顏色與圖示對應
    const FACILITY_STYLE = {
        '教室701': { color: 'bg-emerald-100 text-emerald-700', icon: 'ri-community-line' },
        '教室702': { color: 'bg-emerald-100 text-emerald-700', icon: 'ri-community-line' },
        '教室703': { color: 'bg-emerald-100 text-emerald-700', icon: 'ri-community-line' },
        '空呼氣訓練場': { color: 'bg-blue-100 text-blue-700', icon: 'ri-lungs-line' },
        '燃燒櫃': { color: 'bg-orange-100 text-orange-700', icon: 'ri-fire-line' },
        '燃燒室': { color: 'bg-red-100 text-red-700', icon: 'ri-home-4-line' },
        '大直訓練場': { color: 'bg-sky-100 text-sky-700', icon: 'ri-building-2-line' }
    };

    // --- 1. 即時驗證 ---
    function validateTime() {
        const s = $('#startTime').value;
        const e = $('#endTime').value;
        const err = $('#timeError');
        if(s && e && e <= s) {
            err.classList.remove('hidden');
            $('#endTime').classList.add('border-rose-500', 'ring-1', 'ring-rose-500');
            return false;
        } else {
            err.classList.add('hidden');
            $('#endTime').classList.remove('border-rose-500', 'ring-1', 'ring-rose-500');
            return true;
        }
    }
    $('#startTime').addEventListener('change', validateTime);
    $('#endTime').addEventListener('change', validateTime);

    // --- 2. 表單提交 ---
    form.addEventListener('submit', async e => {
      e.preventDefault();
      if(!validateTime()) { toast('時間設定有誤', true); return; }

      const editId = editIdInput.value;
      const basicData = {
          unit: $('#unit').value.trim(),
          contact: $('#contact').value.trim(),
          phone: $('#phone').value.trim(),
          facility: $('#facility').value,
          purpose: $('#purpose').value.trim(),
          startTime: $('#startTime').value,
          endTime: $('#endTime').value,
          updatedAt: new Date().toISOString()
      };
      
      const date = $('#date').value;
      const dateStart = $('#dateStart').value;
      const dateEnd = $('#dateEnd').value;
      const dates = (dateStart && dateEnd && !editId) 
        ? listDates(dateStart, dateEnd, {
            excludeWeekend: $('#excludeWeekend').checked,
            excludeDates: $('#excludeDates').value.split(',').map(s=>s.trim())
          })
        : [date];

      let data = load();
      if (editId) data = data.filter(x => x.id !== editId);

      const s = timeToMin(basicData.startTime);
      const eM = timeToMin(basicData.endTime);
      const created = [], conflicts = [];

      for (const d of dates) {
          if(data.some(x => x.date === d && x.facility === basicData.facility && overlap(s, eM, timeToMin(x.startTime), timeToMin(x.endTime)))) {
              conflicts.push(d); continue;
          }
          created.push({ id: editId || crypto.randomUUID(), date: d, ...basicData });
      }

      if(created.length === 0 && conflicts.length > 0) {
          toast('所選時段皆已被預約', true);
          return;
      }

      data = [...data, ...created].sort((a, b) => (a.date + a.startTime).localeCompare(b.date + b.startTime));
      save(data);

      // GAS Sync
      if(GAS_ENDPOINT) {
          created.forEach(x => fetch(GAS_ENDPOINT, { method: 'POST', mode: 'no-cors', body: JSON.stringify(x) }).catch(()=>{}));
      }

      resetForm();
      render();
      
      const msg = editId ? '修改成功' : `成功預約 ${created.length} 筆`;
      const conflictMsg = conflicts.length ? ` (跳過 ${conflicts.length} 筆衝突)` : '';
      toast(msg + conflictMsg, false);
    });

    // --- 3. 渲染邏輯 (同時處理 Table 和 Mobile Cards) ---
    const filters = { date: '', facility: '', search: '' };
    ['filterDate', 'filterFacility', 'searchInput'].forEach(id => {
        $('#'+id).addEventListener('input', (e) => {
            if(id === 'filterDate') filters.date = e.target.value;
            if(id === 'filterFacility') filters.facility = e.target.value;
            if(id === 'searchInput') filters.search = e.target.value.toLowerCase();
            render();
        });
    });
    $('#clearFilters').addEventListener('click', () => {
        filters.date = ''; filters.facility = ''; filters.search = '';
        $('#filterDate').value = ''; $('#filterFacility').value = ''; $('#searchInput').value = '';
        render();
    });

    function render() {
        const data = load();
        const filtered = data.filter(x => {
            const matchDate = !filters.date || x.date === filters.date;
            const matchFac = !filters.facility || x.facility === filters.facility;
            const matchSearch = !filters.search || (x.unit+x.contact+x.purpose).toLowerCase().includes(filters.search);
            return matchDate && matchFac && matchSearch;
        });

        bookingTbody.innerHTML = '';
        mobileCardList.innerHTML = '';
        countDisplay.textContent = filtered.length;

        if(filtered.length === 0) {
            emptyState.classList.remove('hidden');
            emptyState.classList.add('flex');
        } else {
            emptyState.classList.add('hidden');
            emptyState.classList.remove('flex');
            
            filtered.forEach(x => {
                const style = FACILITY_STYLE[x.facility] || {color: 'bg-gray-100 text-gray-600', icon: 'ri-building-line'};
                const badge = `<span class="inline-flex items-center gap-1 px-2 py-1 rounded-md text-xs font-medium ${style.color}"><i class="${style.icon}"></i> ${x.facility}</span>`;
                
                // Desktop Table Row
                const tr = document.createElement('tr');
                tr.className = "hover:bg-gray-50 transition group";
                tr.innerHTML = `
                    <td class="p-4 text-slate-600 font-mono">${x.date}</td>
                    <td class="p-4 text-slate-800 font-bold font-mono">${x.startTime} - ${x.endTime}</td>
                    <td class="p-4">${badge}</td>
                    <td class="p-4">
                        <div class="font-bold text-slate-700 text-sm mb-0.5">${x.unit}</div>
                        <div class="text-xs text-slate-500 flex items-center gap-2">
                            <span><i class="ri-user-line"></i> ${x.contact}</span>
                            <span><i class="ri-phone-line"></i> ${x.phone}</span>
                        </div>
                        ${x.purpose ? `<div class="mt-1 text-xs text-slate-400 truncate max-w-[200px]"><i class="ri-chat-1-line"></i> ${x.purpose}</div>` : ''}
                    </td>
                    <td class="p-4 text-right">
                        <div class="flex justify-end gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                            <button onclick="edit('${x.id}')" class="p-1.5 text-indigo-600 hover:bg-indigo-50 rounded"><i class="ri-edit-line text-lg"></i></button>
                            <button onclick="del('${x.id}')" class="p-1.5 text-rose-500 hover:bg-rose-50 rounded"><i class="ri-delete-bin-line text-lg"></i></button>
                        </div>
                    </td>
                `;
                bookingTbody.appendChild(tr);

                // Mobile Card
                const card = document.createElement('div');
                card.className = "mobile-card bg-white p-4 rounded-xl shadow-sm border border-gray-200 relative";
                card.innerHTML = `
                    <div class="flex justify-between items-start mb-2">
                        <div class="font-mono text-indigo-600 font-bold text-lg tracking-tight">${x.startTime} - ${x.endTime}</div>
                        <div class="text-xs text-slate-400 font-mono bg-gray-100 px-2 py-1 rounded">${x.date}</div>
                    </div>
                    <div class="mb-3">${badge}</div>
                    <div class="mb-3 pl-3 border-l-2 border-indigo-100">
                        <div class="font-bold text-slate-800">${x.unit}</div>
                        <div class="text-sm text-slate-500">${x.contact} <span class="mx-1">·</span> ${x.phone}</div>
                        ${x.purpose ? `<div class="text-xs text-slate-400 mt-1 line-clamp-1">${x.purpose}</div>` : ''}
                    </div>
                    <div class="flex justify-end gap-3 pt-2 border-t border-gray-100 mt-2">
                        <button onclick="edit('${x.id}')" class="flex items-center gap-1 text-sm text-indigo-600 font-medium px-2 py-1 active:bg-indigo-50 rounded"><i class="ri-edit-line"></i> 編輯</button>
                        <button onclick="del('${x.id}')" class="flex items-center gap-1 text-sm text-rose-500 font-medium px-2 py-1 active:bg-rose-50 rounded"><i class="ri-delete-bin-line"></i> 刪除</button>
                    </div>
                `;
                mobileCardList.appendChild(card);
            });
        }
    }

    // --- 4. 操作功能 ---
    window.edit = (id) => {
        const r = load().find(x => x.id === id);
        if(!r) return;
        $('#editId').value = r.id;
        $('#unit').value = r.unit;
        $('#contact').value = r.contact;
        $('#phone').value = r.phone;
        $('#facility').value = r.facility;
        $('#purpose').value = r.purpose || '';
        $('#date').value = r.date;
        $('#startTime').value = r.startTime;
        $('#endTime').value = r.endTime;

        // UI State Change
        $('#formTitle').textContent = '編輯預約';
        $('#submitBtn').innerHTML = '<i class="ri-save-line"></i> <span>確認修改</span>';
        $('#submitBtn').className = $('#submitBtn').className.replace('bg-indigo-600', 'bg-emerald-600').replace('shadow-indigo-200', 'shadow-emerald-200').replace('hover:bg-indigo-700', 'hover:bg-emerald-700');
        cancelEditBtn.classList.remove('hidden');
        
        window.scrollTo({top:0, behavior:'smooth'});
        // 關閉多日選項 (編輯模式不支援)
        $('details').removeAttribute('open');
        $('details').classList.add('opacity-50', 'pointer-events-none');
    };

    window.del = (id) => {
        if(!confirm('確定要刪除此筆資料嗎？')) return;
        save(load().filter(x => x.id !== id));
        render();
        toast('已刪除資料', true);
    };

    function resetForm() {
        form.reset();
        $('#date').value = todayISO();
        $('#editId').value = '';
        $('#formTitle').textContent = '新增預約';
        $('#submitBtn').innerHTML = '<i class="ri-check-double-line"></i> <span>送出登記</span>';
        // Reset Button Style
        $('#submitBtn').className = "w-full rounded-xl bg-indigo-600 text-white py-3 text-sm font-semibold shadow-lg shadow-indigo-200 hover:bg-indigo-700 hover:shadow-indigo-300 active:scale-[0.98] transition-all flex items-center justify-center gap-2";
        
        cancelEditBtn.classList.add('hidden');
        $('#timeError').classList.add('hidden');
        $('#endTime').classList.remove('border-rose-500');
        $('details').classList.remove('opacity-50', 'pointer-events-none');
    }
    cancelEditBtn.addEventListener('click', resetForm);

    // Helper: Date List
    function listDates(s, e, opt={}) {
        const out = []; let d = new Date(s), end = new Date(e);
        const excl = new Set(opt.excludeDates||[]);
        while(d<=end) {
            const iso = d.toISOString().slice(0,10), day = d.getDay();
            if(!excl.has(iso) && (!opt.excludeWeekend || (day!==0 && day!==6))) out.push(iso);
            d.setDate(d.getDate()+1);
        }
        return out;
    }

    // --- 5. Toast ---
    function toast(msg, isWarn) {
        const t = $('#toast');
        t.innerHTML = `<i class="${isWarn ? 'ri-alert-line' : 'ri-checkbox-circle-line'} text-lg"></i> ${msg}`;
        t.className = `fixed bottom-6 left-1/2 -translate-x-1/2 px-5 py-3 rounded-full shadow-xl text-white font-medium text-sm transition-all transform duration-300 z-50 flex items-center gap-2 ${isWarn ? 'bg-rose-600' : 'bg-emerald-600'}`;
        t.style.opacity = '1'; t.style.transform = 'translate(-50%, 0)';
        setTimeout(() => { t.style.opacity = '0'; t.style.transform = 'translate(-50%, 20px)'; }, 3000);
    }

    // --- 6. Import/Export (保留原功能但優化代碼) ---
    $('#exportCsvBtn').onclick = () => {
        const d = load(); if(!d.length) return toast('無資料可匯出', true);
        const csv = '\ufeffID,單位,聯絡人,電話,場地,用途,日期,開始,結束\n' + 
            d.map(r => `${r.id},"${r.unit}","${r.contact}","${r.phone}","${r.facility}","${r.purpose||''}",${r.date},${r.startTime},${r.endTime}`).join('\n');
        const a = document.createElement('a'); a.href=URL.createObjectURL(new Blob([csv],{type:'text/csv'})); a.download=`booking_${todayISO()}.csv`; a.click();
    };
    $('#exportJsonBtn').onclick = () => {
        const a = document.createElement('a'); a.href=URL.createObjectURL(new Blob([JSON.stringify(load(),null,2)],{type:'application/json'})); a.download=`backup_${todayISO()}.json`; a.click();
    };
    $('#importJsonInput').onchange = (e) => {
        const fr = new FileReader(); fr.readAsText(e.target.files[0]);
        fr.onload = ev => {
            try { save(JSON.parse(ev.target.result)); render(); toast('資料已還原'); } catch { toast('檔案格式錯誤', true); }
            e.target.value = '';
        };
    };

    render();
  </script>
</body>
</html>
